'use strict';

/**
 * 全局状态
 * @type {Object}
 */
var Base = {
  loading: false,
  fileQueue: [],
  fileSize: 0,
  count: 0
};

/**
 * 初始化BOX
 */
function initFiles() {
  Base.fileQueue = [];
  Base.fileSize = 0;
}

/**
 * 初始化提示内容
 */
function initHint() {
  var len = document.querySelector('#fileLength');
  var size = document.querySelector('#fileSize');
  var detail = document.querySelector('#fileDetail');

  len.innerHTML = 0;
  size.innerHTML = 0;
  detail.innerHTML = '';
}

/** DOMContentLoad Event */
document.addEventListener('DOMContentLoaded', function () {
  var input = document.querySelector('.file-select__input');
  var dropbox = document.querySelector('.file-control__drop');

  var clean = document.querySelector('#clear');
  var upload = document.querySelector('#upload');

  // select file
  input.addEventListener('change', select, false);

  // Drag & Drop
  dropbox.addEventListener('dragenter', dragenter, false);
  dropbox.addEventListener('dragover', dragover, false);
  dropbox.addEventListener('dragleave', dragleave, false);
  dropbox.addEventListener('drop', drop, false);

  // upload or clear files
  clean.addEventListener('click', init, false);
  upload.addEventListener('click', uploadAll, false);
}, false);

/** OnLoad Event */
window.addEventListener('load', function () {
  var clean = document.querySelector('#clear');

  clean.click();
}, false);

/**
 * 初始化
 * @param {Object} e 事件对象
 */
function init(e) {
  // 正在上传时阻止操作
  if (!Base.loading) {
    initHint();
    initFiles();
  }

  e.preventDefault();
}

/**
 * 上传所有图片
 * @param {Object} e 事件对象
 */
function uploadAll(e) {
  var len = Base.fileQueue.length;
  var item;
  var t;

  // 正在上传时阻止操作
  if (Base.loading) {
    return;
  }

  while (item = Base.fileQueue.pop()) {
    if (item.file.size < 1048576) {
      upload(item.file, item.li, len);
    } else {
      t = item.li.querySelector('.progress');
      t.classList.add('fail');
      t.innerHTML = '<em>上传失败，图片大于1M</em>';
    }
  }

  e.preventDefault();
}

/**
 * 图片进入drop zone时触发的事件
 * @param {Object} e 事件对象
 */
function dragenter(e) {
  var c = Base.loading ? 'file-control__drop--block' : 'file-control__drop--hover';

  e.target.classList.add(c);

  e.preventDefault();
  e.stopPropagation();
}

/**
 * 图片在drop zone内时连续触发的事件
 * @param {Object} e 事件对象
 */
function dragover(e) {
  e.preventDefault();
  e.stopPropagation();
}

/**
 * 图片移出drop zone时触发的事件
 * @param  {Object} e 事件对象
 */
function dragleave(e) {
  e.preventDefault();
  e.stopPropagation();

  e.target.classList.remove('file-control__drop--hover', 'file-control__drop--block');
}

/**
 * drop时触发的事件
 * @param {Object} e 事件对象
 */
function drop(e) {
  e.target.classList.remove('file-control__drop--hover', 'file-control__drop--block');

  // 正在上传时阻止操作
  if (!Base.loading) {
    handleFiles(e.dataTransfer.files);
  }

  e.preventDefault();
  e.stopPropagation();
}

/**
 * 通过文件输入框选择图片后触发
 * @param {Object} e 事件对象
 */
function select(e) {
  // 正在上传时阻止操作
  if (!Base.loading) {
    handleFiles(e.target.files);
  }

  this.value = '';
}

/**
 * 处理添加的图片，包括预览和全局对象存储图片信息
 * @param {Object} files FileList Object
 */
function handleFiles(files) {
  var unit = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
  var t = document.querySelector('#fileDetail');
  var hintLen = document.querySelector('#fileLength');
  var hintSize = document.querySelector('#fileSize');
  var df = document.createDocumentFragment();
  // 文件总大小
  var size = 0;
  // component
  var li;
  var img;
  var progress;
  var bar;

  for (var i = 0; i < files.length; i++) {
    // component
    li = document.createElement('li');
    li.dataset.name = files[i].name;
    li.dataset.size = files[i].size;

    // preview
    img = document.createElement('span');
    img.classList.add('preview');
    img.appendChild(buildThumbnail(files[i]));

    // progress bar
    progress = document.createElement('progress');
    progress.value = 0;
    progress.max = 100;
    progress.innerHTML = '0%';

    bar = document.createElement('span');
    bar.classList.add('progress');
    bar.appendChild(progress);

    // concat
    li.appendChild(img);
    li.appendChild(bar);
    df.appendChild(li);

    // update Global information
    Base.fileQueue.push({
      file: files[i],
      li: li
    });

    Base.fileSize += files[i].size;
  }

  t.appendChild(df);

  // totoal size
  for (var j = 0, temp = Base.fileSize; temp > 1; temp /= 1024, j++) {
    size = temp.toFixed(3) + unit[j];
  }

  hintLen.innerHTML = Base.fileQueue.length;
  hintSize.innerHTML = size;
}

/**
 * 创建缩略图对象
 * @param  {Object} file File Object
 * @return {Object} Image Object
 */
function buildThumbnail(file) {
  var imgURL;
  var img;

  imgURL = window.URL.createObjectURL(file);

  img = new Image();
  img.src = imgURL;

  img.onload = function () {
    window.URL.revokeObjectURL(imgURL);
  };

  return img;
}

/**
 * 上传一张图片
 * @param {Object} file File Object
 * @param {Element} li 关联预览元素
 * @param {Number} count 需上传图片数量
 */
function upload(file, li, count) {
  var t = li.querySelector('.progress');

  if (file && t) {
    ajax('uploads', file, t).then(function (data) {
      t.classList.add('done');
      t.innerHTML = '<em>上传成功</em>';
      console.log(data);

      // 计数
      Base.count++;
      console.log(Base.count);
      if (Base.count === count) {
        Base.loading = false;
      }
    }).catch(function (err) {
      t.classList.add('fail');
      t.innerHTML = '<em>上传失败</em>';

      console.log(err);
    });
  }
}

/**
 * ajax
 * @param {String} url  Upload URL
 * @param {Object} data File Object
 * @param {Element} t 进度条容器对象
 * @return {Promist} Promise Object
 */
function ajax(url, data, t) {
  var progress = t.querySelector('progress');

  return new Promise(function (resolve, reject) {
    var xhr = new XMLHttpRequest();
    var formData = new FormData();

    formData.append('fileField', data);

    // upload progress bar
    xhr.upload.onprogress = function (e) {
      var pct;

      if (e.lengthComputable) {
        pct = Math.round(e.loaded / e.total * 100);

        progress.value = 0;
        progress.innerHTML = pct + '%';
        console.log(pct);
      }
    };

    xhr.onloadstart = function () {
      Base.loading = true;
    };

    xhr.onload = function () {
      if (this.status >= 200 && this.status < 300) {
        resolve(JSON.parse(this.response));
      }
    };

    xhr.onerror = function () {
      reject('XHR error');
    };

    xhr.open('POST', url, true);
    xhr.send(formData);
  });
}
//# sourceMappingURL=data:application/json;base64,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QUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7R0FDcEIsQ0FBQyxDQUFDO0NBQ0oiLCJmaWxlIjoiZmlsZS1hcGkvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICog5YWo5bGA54q25oCBXG4gKiBAdHlwZSB7T2JqZWN0fVxuICovXG52YXIgQmFzZSA9IHtcbiAgbG9hZGluZzogZmFsc2UsXG4gIGZpbGVRdWV1ZTogW10sXG4gIGZpbGVTaXplOiAwLFxuICBjb3VudDogMFxufTtcblxuLyoqXG4gKiDliJ3lp4vljJZCT1hcbiAqL1xuZnVuY3Rpb24gaW5pdEZpbGVzKCkge1xuICBCYXNlLmZpbGVRdWV1ZSA9IFtdO1xuICBCYXNlLmZpbGVTaXplID0gMDtcbn1cblxuLyoqXG4gKiDliJ3lp4vljJbmj5DnpLrlhoXlrrlcbiAqL1xuZnVuY3Rpb24gaW5pdEhpbnQoKSB7XG4gIHZhciBsZW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZmlsZUxlbmd0aCcpO1xuICB2YXIgc2l6ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNmaWxlU2l6ZScpO1xuICB2YXIgZGV0YWlsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2ZpbGVEZXRhaWwnKTtcblxuICBsZW4uaW5uZXJIVE1MID0gMDtcbiAgc2l6ZS5pbm5lckhUTUwgPSAwO1xuICBkZXRhaWwuaW5uZXJIVE1MID0gJyc7XG59XG5cbi8qKiBET01Db250ZW50TG9hZCBFdmVudCAqL1xuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKCkge1xuICB2YXIgaW5wdXQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZmlsZS1zZWxlY3RfX2lucHV0Jyk7XG4gIHZhciBkcm9wYm94ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmZpbGUtY29udHJvbF9fZHJvcCcpO1xuXG4gIHZhciBjbGVhbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNjbGVhcicpO1xuICB2YXIgdXBsb2FkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3VwbG9hZCcpO1xuXG4gIC8vIHNlbGVjdCBmaWxlXG4gIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHNlbGVjdCwgZmFsc2UpO1xuXG4gIC8vIERyYWcgJiBEcm9wXG4gIGRyb3Bib3guYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2VudGVyJywgZHJhZ2VudGVyLCBmYWxzZSk7XG4gIGRyb3Bib3guYWRkRXZlbnRMaXN0ZW5lcignZHJhZ292ZXInLCBkcmFnb3ZlciwgZmFsc2UpO1xuICBkcm9wYm94LmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdsZWF2ZScsIGRyYWdsZWF2ZSwgZmFsc2UpO1xuICBkcm9wYm94LmFkZEV2ZW50TGlzdGVuZXIoJ2Ryb3AnLCBkcm9wLCBmYWxzZSk7XG5cbiAgLy8gdXBsb2FkIG9yIGNsZWFyIGZpbGVzXG4gIGNsZWFuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaW5pdCwgZmFsc2UpO1xuICB1cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB1cGxvYWRBbGwsIGZhbHNlKTtcbn0sIGZhbHNlKTtcblxuLyoqIE9uTG9hZCBFdmVudCAqL1xud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbigpIHtcbiAgdmFyIGNsZWFuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NsZWFyJyk7XG5cbiAgY2xlYW4uY2xpY2soKTtcbn0sIGZhbHNlKTtcblxuLyoqXG4gKiDliJ3lp4vljJZcbiAqIEBwYXJhbSB7T2JqZWN0fSBlIOS6i+S7tuWvueixoVxuICovXG5mdW5jdGlvbiBpbml0KGUpIHtcbiAgLy8g5q2j5Zyo5LiK5Lyg5pe26Zi75q2i5pON5L2cXG4gIGlmICghQmFzZS5sb2FkaW5nKSB7XG4gICAgaW5pdEhpbnQoKTtcbiAgICBpbml0RmlsZXMoKTtcbiAgfVxuXG4gIGUucHJldmVudERlZmF1bHQoKTtcbn1cblxuLyoqXG4gKiDkuIrkvKDmiYDmnInlm77niYdcbiAqIEBwYXJhbSB7T2JqZWN0fSBlIOS6i+S7tuWvueixoVxuICovXG5mdW5jdGlvbiB1cGxvYWRBbGwoZSkge1xuICB2YXIgbGVuID0gQmFzZS5maWxlUXVldWUubGVuZ3RoO1xuICB2YXIgaXRlbTtcbiAgdmFyIHQ7XG5cbiAgLy8g5q2j5Zyo5LiK5Lyg5pe26Zi75q2i5pON5L2cXG4gIGlmIChCYXNlLmxvYWRpbmcpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICB3aGlsZSAoKGl0ZW0gPSBCYXNlLmZpbGVRdWV1ZS5wb3AoKSkpIHtcbiAgICBpZiAoaXRlbS5maWxlLnNpemUgPCAxMDQ4NTc2KSB7XG4gICAgICB1cGxvYWQoaXRlbS5maWxlLCBpdGVtLmxpLCBsZW4pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0ID0gaXRlbS5saS5xdWVyeVNlbGVjdG9yKCcucHJvZ3Jlc3MnKTtcbiAgICAgIHQuY2xhc3NMaXN0LmFkZCgnZmFpbCcpO1xuICAgICAgdC5pbm5lckhUTUwgPSAnPGVtPuS4iuS8oOWksei0pe+8jOWbvueJh+Wkp+S6jjFNPC9lbT4nO1xuICAgIH1cbiAgfVxuXG4gIGUucHJldmVudERlZmF1bHQoKTtcbn1cblxuLyoqXG4gKiDlm77niYfov5vlhaVkcm9wIHpvbmXml7bop6blj5HnmoTkuovku7ZcbiAqIEBwYXJhbSB7T2JqZWN0fSBlIOS6i+S7tuWvueixoVxuICovXG5mdW5jdGlvbiBkcmFnZW50ZXIoZSkge1xuICB2YXIgYyA9IEJhc2UubG9hZGluZyA/XG4gICAgJ2ZpbGUtY29udHJvbF9fZHJvcC0tYmxvY2snIDogJ2ZpbGUtY29udHJvbF9fZHJvcC0taG92ZXInO1xuXG4gIGUudGFyZ2V0LmNsYXNzTGlzdC5hZGQoYyk7XG5cbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICBlLnN0b3BQcm9wYWdhdGlvbigpO1xufVxuXG4vKipcbiAqIOWbvueJh+WcqGRyb3Agem9uZeWGheaXtui/nue7reinpuWPkeeahOS6i+S7tlxuICogQHBhcmFtIHtPYmplY3R9IGUg5LqL5Lu25a+56LGhXG4gKi9cbmZ1bmN0aW9uIGRyYWdvdmVyKGUpIHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICBlLnN0b3BQcm9wYWdhdGlvbigpO1xufVxuXG4vKipcbiAqIOWbvueJh+enu+WHumRyb3Agem9uZeaXtuinpuWPkeeahOS6i+S7tlxuICogQHBhcmFtICB7T2JqZWN0fSBlIOS6i+S7tuWvueixoVxuICovXG5mdW5jdGlvbiBkcmFnbGVhdmUoZSkge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgZS50YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgnZmlsZS1jb250cm9sX19kcm9wLS1ob3ZlcicsXG4gICAgJ2ZpbGUtY29udHJvbF9fZHJvcC0tYmxvY2snKTtcbn1cblxuLyoqXG4gKiBkcm9w5pe26Kem5Y+R55qE5LqL5Lu2XG4gKiBAcGFyYW0ge09iamVjdH0gZSDkuovku7blr7nosaFcbiAqL1xuZnVuY3Rpb24gZHJvcChlKSB7XG4gIGUudGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoJ2ZpbGUtY29udHJvbF9fZHJvcC0taG92ZXInLFxuICAgICdmaWxlLWNvbnRyb2xfX2Ryb3AtLWJsb2NrJyk7XG5cbiAgLy8g5q2j5Zyo5LiK5Lyg5pe26Zi75q2i5pON5L2cXG4gIGlmICghQmFzZS5sb2FkaW5nKSB7XG4gICAgaGFuZGxlRmlsZXMoZS5kYXRhVHJhbnNmZXIuZmlsZXMpO1xuICB9XG5cbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICBlLnN0b3BQcm9wYWdhdGlvbigpO1xufVxuXG4vKipcbiAqIOmAmui/h+aWh+S7tui+k+WFpeahhumAieaLqeWbvueJh+WQjuinpuWPkVxuICogQHBhcmFtIHtPYmplY3R9IGUg5LqL5Lu25a+56LGhXG4gKi9cbmZ1bmN0aW9uIHNlbGVjdChlKSB7XG4gIC8vIOato+WcqOS4iuS8oOaXtumYu+atouaTjeS9nFxuICBpZiAoIUJhc2UubG9hZGluZykge1xuICAgIGhhbmRsZUZpbGVzKGUudGFyZ2V0LmZpbGVzKTtcbiAgfVxuXG4gIHRoaXMudmFsdWUgPSAnJztcbn1cblxuLyoqXG4gKiDlpITnkIbmt7vliqDnmoTlm77niYfvvIzljIXmi6zpooTop4jlkozlhajlsYDlr7nosaHlrZjlgqjlm77niYfkv6Hmga9cbiAqIEBwYXJhbSB7T2JqZWN0fSBmaWxlcyBGaWxlTGlzdCBPYmplY3RcbiAqL1xuZnVuY3Rpb24gaGFuZGxlRmlsZXMoZmlsZXMpIHtcbiAgdmFyIHVuaXQgPSBbJ0InLCAnS0InLCAnTUInLCAnR0InLCAnVEInLCAnUEInLCAnRUInLCAnWkInLCAnWUInXTtcbiAgdmFyIHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZmlsZURldGFpbCcpO1xuICB2YXIgaGludExlbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNmaWxlTGVuZ3RoJyk7XG4gIHZhciBoaW50U2l6ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNmaWxlU2l6ZScpO1xuICB2YXIgZGYgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG4gIC8vIOaWh+S7tuaAu+Wkp+Wwj1xuICB2YXIgc2l6ZSA9IDA7XG4gIC8vIGNvbXBvbmVudFxuICB2YXIgbGk7XG4gIHZhciBpbWc7XG4gIHZhciBwcm9ncmVzcztcbiAgdmFyIGJhcjtcblxuICBmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgLy8gY29tcG9uZW50XG4gICAgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xuICAgIGxpLmRhdGFzZXQubmFtZSA9IGZpbGVzW2ldLm5hbWU7XG4gICAgbGkuZGF0YXNldC5zaXplID0gZmlsZXNbaV0uc2l6ZTtcblxuICAgIC8vIHByZXZpZXdcbiAgICBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gICAgaW1nLmNsYXNzTGlzdC5hZGQoJ3ByZXZpZXcnKTtcbiAgICBpbWcuYXBwZW5kQ2hpbGQoYnVpbGRUaHVtYm5haWwoZmlsZXNbaV0pKTtcblxuICAgIC8vIHByb2dyZXNzIGJhclxuICAgIHByb2dyZXNzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncHJvZ3Jlc3MnKTtcbiAgICBwcm9ncmVzcy52YWx1ZSA9IDA7XG4gICAgcHJvZ3Jlc3MubWF4ID0gMTAwO1xuICAgIHByb2dyZXNzLmlubmVySFRNTCA9ICcwJSc7XG5cbiAgICBiYXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gICAgYmFyLmNsYXNzTGlzdC5hZGQoJ3Byb2dyZXNzJyk7XG4gICAgYmFyLmFwcGVuZENoaWxkKHByb2dyZXNzKTtcblxuICAgIC8vIGNvbmNhdFxuICAgIGxpLmFwcGVuZENoaWxkKGltZyk7XG4gICAgbGkuYXBwZW5kQ2hpbGQoYmFyKTtcbiAgICBkZi5hcHBlbmRDaGlsZChsaSk7XG5cbiAgICAvLyB1cGRhdGUgR2xvYmFsIGluZm9ybWF0aW9uXG4gICAgQmFzZS5maWxlUXVldWUucHVzaCh7XG4gICAgICBmaWxlOiBmaWxlc1tpXSxcbiAgICAgIGxpOiBsaVxuICAgIH0pO1xuXG4gICAgQmFzZS5maWxlU2l6ZSArPSBmaWxlc1tpXS5zaXplO1xuICB9XG5cbiAgdC5hcHBlbmRDaGlsZChkZik7XG5cbiAgLy8gdG90b2FsIHNpemVcbiAgZm9yICh2YXIgaiA9IDAsIHRlbXAgPSBCYXNlLmZpbGVTaXplOyB0ZW1wID4gMTsgdGVtcCAvPSAxMDI0LCBqKyspIHtcbiAgICBzaXplID0gdGVtcC50b0ZpeGVkKDMpICsgdW5pdFtqXTtcbiAgfVxuXG4gIGhpbnRMZW4uaW5uZXJIVE1MID0gQmFzZS5maWxlUXVldWUubGVuZ3RoO1xuICBoaW50U2l6ZS5pbm5lckhUTUwgPSBzaXplO1xufVxuXG4vKipcbiAqIOWIm+W7uue8qeeVpeWbvuWvueixoVxuICogQHBhcmFtICB7T2JqZWN0fSBmaWxlIEZpbGUgT2JqZWN0XG4gKiBAcmV0dXJuIHtPYmplY3R9IEltYWdlIE9iamVjdFxuICovXG5mdW5jdGlvbiBidWlsZFRodW1ibmFpbChmaWxlKSB7XG4gIHZhciBpbWdVUkw7XG4gIHZhciBpbWc7XG5cbiAgaW1nVVJMID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoZmlsZSk7XG5cbiAgaW1nID0gbmV3IEltYWdlKCk7XG4gIGltZy5zcmMgPSBpbWdVUkw7XG5cbiAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKGltZ1VSTCk7XG4gIH07XG5cbiAgcmV0dXJuIGltZztcbn1cblxuLyoqXG4gKiDkuIrkvKDkuIDlvKDlm77niYdcbiAqIEBwYXJhbSB7T2JqZWN0fSBmaWxlIEZpbGUgT2JqZWN0XG4gKiBAcGFyYW0ge0VsZW1lbnR9IGxpIOWFs+iBlOmihOiniOWFg+e0oFxuICogQHBhcmFtIHtOdW1iZXJ9IGNvdW50IOmcgOS4iuS8oOWbvueJh+aVsOmHj1xuICovXG5mdW5jdGlvbiB1cGxvYWQoZmlsZSwgbGksIGNvdW50KSB7XG4gIHZhciB0ID0gbGkucXVlcnlTZWxlY3RvcignLnByb2dyZXNzJyk7XG5cbiAgaWYgKGZpbGUgJiYgdCkge1xuICAgIGFqYXgoJ3VwbG9hZHMnLCBmaWxlLCB0KS50aGVuKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgIHQuY2xhc3NMaXN0LmFkZCgnZG9uZScpO1xuICAgICAgdC5pbm5lckhUTUwgPSAnPGVtPuS4iuS8oOaIkOWKnzwvZW0+JztcbiAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuXG4gICAgICAvLyDorqHmlbBcbiAgICAgIEJhc2UuY291bnQrKztcbiAgICAgIGNvbnNvbGUubG9nKEJhc2UuY291bnQpO1xuICAgICAgaWYgKEJhc2UuY291bnQgPT09IGNvdW50KSB7XG4gICAgICAgIEJhc2UubG9hZGluZyA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgdC5jbGFzc0xpc3QuYWRkKCdmYWlsJyk7XG4gICAgICB0LmlubmVySFRNTCA9ICc8ZW0+5LiK5Lyg5aSx6LSlPC9lbT4nO1xuXG4gICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogYWpheFxuICogQHBhcmFtIHtTdHJpbmd9IHVybCAgVXBsb2FkIFVSTFxuICogQHBhcmFtIHtPYmplY3R9IGRhdGEgRmlsZSBPYmplY3RcbiAqIEBwYXJhbSB7RWxlbWVudH0gdCDov5vluqbmnaHlrrnlmajlr7nosaFcbiAqIEByZXR1cm4ge1Byb21pc3R9IFByb21pc2UgT2JqZWN0XG4gKi9cbmZ1bmN0aW9uIGFqYXgodXJsLCBkYXRhLCB0KSB7XG4gIHZhciBwcm9ncmVzcyA9IHQucXVlcnlTZWxlY3RvcigncHJvZ3Jlc3MnKTtcblxuICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuXG4gICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlRmllbGQnLCBkYXRhKTtcblxuICAgIC8vIHVwbG9hZCBwcm9ncmVzcyBiYXJcbiAgICB4aHIudXBsb2FkLm9ucHJvZ3Jlc3MgPSBmdW5jdGlvbihlKSB7XG4gICAgICB2YXIgcGN0O1xuXG4gICAgICBpZiAoZS5sZW5ndGhDb21wdXRhYmxlKSB7XG4gICAgICAgIHBjdCA9IE1hdGgucm91bmQoZS5sb2FkZWQgLyBlLnRvdGFsICogMTAwKTtcblxuICAgICAgICBwcm9ncmVzcy52YWx1ZSA9IDA7XG4gICAgICAgIHByb2dyZXNzLmlubmVySFRNTCA9IHBjdCArICclJztcbiAgICAgICAgY29uc29sZS5sb2cocGN0KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgeGhyLm9ubG9hZHN0YXJ0ID0gZnVuY3Rpb24oKSB7XG4gICAgICBCYXNlLmxvYWRpbmcgPSB0cnVlO1xuICAgIH07XG5cbiAgICB4aHIub25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgICBpZiAodGhpcy5zdGF0dXMgPj0gMjAwICYmIHRoaXMuc3RhdHVzIDwgMzAwKSB7XG4gICAgICAgIHJlc29sdmUoSlNPTi5wYXJzZSh0aGlzLnJlc3BvbnNlKSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHhoci5vbmVycm9yID0gZnVuY3Rpb24oKSB7XG4gICAgICByZWplY3QoJ1hIUiBlcnJvcicpO1xuICAgIH07XG5cbiAgICB4aHIub3BlbignUE9TVCcsIHVybCwgdHJ1ZSk7XG4gICAgeGhyLnNlbmQoZm9ybURhdGEpO1xuICB9KTtcbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
